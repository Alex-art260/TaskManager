@using System.Security.Claims
@model TaskModel;

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Форма задачи</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.OpenAIapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>

    </style>
</head>
<body>
    <div class="form-group">
        <div class="row">
            <div class="col-md-6">
                <h2 class="mb-4">Новая задача</h2>
                <form id="taskForm" action="/Task/Update/@Model.Id" method="post">
                    <input type="hidden" name="Id" value="@Model.Id" />
                    <div class="form-group">
                        <label for="taskName">Название задачи:</label>
                        <input type="text" class="form-control" id="taskName" placeholder="Введите название задачи" value="@Model.Name" readonly>
                    </div>
                    <div class="form-group">
                        <label for="taskDescription">Описание задачи:</label>
                        <textarea class="form-control" id="taskDescription" rows="5" placeholder="Введите описание задачи" disabled>@Model.Description</textarea>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <h2 class="mb-4">Детали задачи</h2>
                <form id="taskForm" >
                    <div class="form-group">
                        <label for="creationDate">Дата создания:</label>
                        <input type="datetime-local" class="form-control" id="creationDate" value="@Model.CreatedDate.ToString("yyyy-MM-ddTHH:mm")" disabled>
                    </div>
                    <div class="form-group">
                        <label for="closingDate">Дата закрытия:</label>
                        <input type="datetime-local" class="form-control" id="closingDate" value="@Model.FinishedDate.ToString("yyyy-MM-ddTHH:mm")" readonly>
                    </div>
                    <div class="form-group">
                        <label for="taskStatus">Статус задачи:</label>
                        <select class="form-control" id="taskStatus" @(Model.AuthorId == User.FindFirstValue(ClaimTypes.NameIdentifier) ? "" : "disabled")>
                            @switch (Model.StatusTask)
                            {
                                case StatusTask.New:
                                    <option value="new" selected>Новая</option>
                                    <option value="inProgress">В работе</option>
                                    <option value="completed">Завершена</option>
                                    break;
                                case StatusTask.InProgress:
                                    <option value="new">Новая</option>
                                    <option value="inProgress" selected>В работе</option>
                                    <option value="completed">Завершена</option>
                                    break;
                                case StatusTask.Completed:
                                    <option value="new">Новая</option>
                                    <option value="inProgress">В работе</option>
                                    <option value="completed" selected>Завершена</option>
                                    break;
                                default:
                                    <option value="new">Новая</option>
                                    <option value="inProgress">В работе</option>
                                    <option value="completed">Завершена</option>
                                    break;
                            }
                        </select>
                    </div>
                </form>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <h2 class="mb-4">Комментарии</h2>
                <textarea class="form-control" id="taskComments" rows="5" placeholder="Добавить комментарии" @Model.Comment></textarea>
            </div>
        </div>
        <div class="form-group" style="margin-top:20px; padding-bottom:80px;">
            <div class="col-md-12">
                <button type="submit" class="btn btn-primary" form="taskForm" id="saveTaskButton">Сохранить задачу</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function () {
            $("#saveTaskButton").click(function () {
                var taskId = $("#taskForm input[name='Id']").val();
                var taskName = $("#taskName").val();
                var taskDescription = $("#taskDescription").val();
                var creationDate = $("#creationDate").val();
                var closingDate = $("#closingDate").val();
                var taskStatus = $("#taskStatus").val();
                var taskComments = $("#taskComments").val();

                console.error(taskName);

                $.ajax({
                    url: "/Task/Update/" + taskId,
                    type: "POST",
                    data: {
                        Id: taskId,
                        Name: taskName, // Передаем все поля
                        Description: taskDescription,
                        CreatedDate: creationDate,
                        FinishedDate: closingDate,
                        StatusTask: taskStatus,
                        Comment: taskComments
                    },
                    success: function (response) {
                        console.error(Name);
                        // Обработка успешного ответа (например, обновление страницы)
                        alert("Задача успешно обновлена!");
                        location.reload();
                    },
                    error: function (error) {
                        // Обработка ошибки
                        console.error("Ошибка при обновлении задачи:", error);
                    }
                });
            });
        });
    </script>

</body>
</html>